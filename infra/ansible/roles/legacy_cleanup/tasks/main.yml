---
- name: Stop and remove legacy Coolify containers if present
  shell: |
    set -euo pipefail
    changed=0
    names=(
    {% for name in legacy_coolify_container_names %}
      "{{ name }}"
    {% endfor %}
    )
    for n in "${names[@]}"; do
      if docker ps -a --format '{{ "{{" }}.Names{{ "}}" }}' 2>/dev/null | grep -qx "$n"; then
        docker rm -f "$n" >/dev/null
        changed=1
      fi
    done
    echo "changed=${changed}"
  args:
    executable: /bin/bash
  register: legacy_container_cleanup
  changed_when: "'changed=1' in legacy_container_cleanup.stdout"
  failed_when: false

- name: Remove legacy Coolify directories
  file:
    path: "{{ item }}"
    state: absent
  loop: "{{ legacy_coolify_paths }}"

- name: Flush legacy Docker DNAT rules when requested
  shell: |
    set -euo pipefail
    if iptables -t nat -S DOCKER >/dev/null 2>&1; then
      iptables -t nat -F DOCKER
    fi
  args:
    executable: /bin/bash
  when: legacy_cleanup_flush_docker_nat | bool
  notify: Persist iptables rules

- name: Stop and mask Docker services when requested
  systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
    masked: true
  loop:
    - docker.service
    - docker.socket
  when: legacy_cleanup_mask_docker | bool
  failed_when: false
